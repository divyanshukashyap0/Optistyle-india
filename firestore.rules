rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is the owner of the document (based on userId field)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if the user is an admin
    // Reads the user's profile from the 'users' collection to verify role
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // Check if the user is the seller assigned to the order
    function isSeller(sellerId) {
      return isAuthenticated() && request.auth.uid == sellerId;
    }

    // --- ORDERS COLLECTION ---
    match /orders/{orderId} {
      
      // READ: 
      // 1. Owner (Buyer) can read.
      // 2. Seller can read (if assigned).
      // 3. Admin can read.
      allow read: if 
        isOwner(resource.data.userId) || 
        isSeller(resource.data.sellerId) || 
        isAdmin();

      // CREATE: 
      // 1. User can create if they assign themselves as userId.
      // 2. Must be authenticated.
      // 3. Admin can create for anyone (optional, but good for support).
      allow create: if 
        isAuthenticated() && 
        (request.resource.data.userId == request.auth.uid || isAdmin());

      // UPDATE:
      // 1. User can update ONLY if they own the order AND do not change sensitive fields.
      //    Sensitive fields: status, paymentStatus, total, userId, sellerId, items.
      // 2. Admin can update anything.
      // 3. Seller can update status (e.g. to 'shipped') - Optional based on logic, but here strict.
      //    Let's restrict Sellers to only updating status if needed, but prompt said "Order status updates restricted (admin / system only)".
      //    We will strictly follow: User updates non-sensitive only. Admin updates all.
      allow update: if 
        isAdmin() || 
        (
          isOwner(resource.data.userId) && 
          // Ensure userId is not changed
          request.resource.data.userId == resource.data.userId &&
          // Ensure sensitive fields are unchanged
          request.resource.data.status == resource.data.status &&
          request.resource.data.paymentStatus == resource.data.paymentStatus &&
          request.resource.data.total == resource.data.total &&
          request.resource.data.sellerId == resource.data.sellerId
        );

      // DELETE:
      // No one can delete orders (Audit trail).
      allow delete: if false;

      // --- SUBCOLLECTION: OrderItems ---
      match /orderItems/{itemId} {
        // Inherit read access from parent Order
        // We must fetch the parent order to check permissions
        allow read: if 
          isOwner(get(/databases/$(database)/documents/orders/$(orderId)).data.userId) ||
          isSeller(get(/databases/$(database)/documents/orders/$(orderId)).data.sellerId) ||
          isAdmin();

        // Write restrictions for subcollection
        // Usually created with the order.
        allow write: if isAdmin(); // strict
      }
    }

    // --- USERS COLLECTION (For Admin Check) ---
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
